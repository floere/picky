Array.prototype.index=function(a){for(var b=0,i=this.length;b<i;b++)if(this[b]==a)return b;return null};Array.prototype.include=function(a){return this.index(a)!==null};Array.prototype.remove=function(a){this.splice(a,1);return this};Array.prototype.compare=function(a){return this.join("")==a.join("")};Array.prototype.each=function(a){for(var b=0,i=this.length;b<i;b++)a(b,this[b]);return this};var dictionary={common:{join:{de:"und",fr:"et",it:"e",en:"and",ch:"und"},"with":{de:"mit",fr:"avec",it:"con",en:"with",ch:"mit"},of:{de:"von",fr:"de",it:"di",en:"of",ch:"vo"},to:{de:"bis",fr:"\u00e0",it:"alla",en:"to",ch:"bis"}},results:{addination:{more:{de:"Weitere Resultate",fr:"Autres r\u00e9sultats",it:"Altri risultati",en:"More results",ch:"Mee Resultaat"}},header:{de:"Ergebnisse",fr:"R\u00e9sultats",it:"Risultati",en:"Results",ch:"Erg\u00e4bnis"}}},t=function(a){for(var b=PickyI18n.locale||
"en",i=a.split(".").concat(b),e=dictionary,f=0,n=i.length;f<n;f++){e=e[i[f]];if(e==undefined){e="Translation missing: "+a+"."+b;break}}return e};function Allocation(a,b,i,e,f,n){var p=this;this.type=a;this.weight=b;this.count=i;this.combination=e;this.ids=f||[];this.entries=this.rendered=n;this.isType=function(s){return s==p.type}}function Allocations(a){this.allocations=[];for(var b=0,i=a.length;b<i;b++){var e=a[b];this.allocations.push(new Allocation(e[0],e[1],e[2],e[3],e[4],e[5]))}this.length=this.allocations.length;this.each=function(f){return this.allocations.each(f)}}
function PickyData(a){var b=a.total,i=a.duration,e=a.offset,f=new Allocations(a.allocations||[]);this.original_hash=a;this.total=b;this.duration=i;this.offset=e;this.allocations=f;this.renderedAmount=function(){var n=0;f.each(function(p,s){n+=s.rendered.length});return n};this.isEmpty=function(){return b==0}};var PickyView=function(a,b){var i=b.showResultsLimit||10,e=b.input,f=b.reset,n=b.button,p=b.counter,s=b.dashboard,u=b.moreSelector,x=b.results,y=b.noResults,j=new PickyAddination(this,x),r=new PickyAllocationsCloud(this,b),d=new PickyResultsRenderer(j,b),h=function(){f.fadeTo(166,1)},g=function(){r.hide();x.empty();y.hide()},q=function(k){e.val(k);f.fadeTo(166,0);v("empty");p.empty();g()},m=function(){return e.val()};this.text=m;var c=function(k){p.text(k);k>0&&k<=5&&p.fadeTo("fast",0.5).fadeTo("fast",
1)},o=function(k){if(k.isEmpty())return"none";if(k.total>i&&k.allocations.length>1)return"support";return"ok"},v=function(k){s.attr("class","dashboard "+k)};this.insert=function(k){e.val(k);e.select()};this.fullResultsCallback=function(k){v(o(k));if(k.isEmpty()){g();c(0);y.show();h()}else if(k.total>i&&k.allocations.length>1){g();h();r.show(k);c(k.total)}else if(k.offset==0){g();c(k.total);d.render(k);x.show();h();e.focus()}else{var w=$(u).position().top;j.remove();d.render(k);$("body").animate({scrollTop:w-
12},500)}};this.liveResultsCallback=function(k){v(o(k));c(k.total)};this.allocationChosen=function(k){k=k.data.query;e.val(k);a.allocationChosen(k)};this.addinationClicked=function(k){a.addinationClicked(m(),k)};(function(){e.keyup(function(k){if(m()==""){q();a.searchTextCleared()}else{a.searchTextEntered(m(),k);h()}});p.click(function(){m()==""||a.searchButtonClicked(m())});n.click(function(){m()==""||a.searchButtonClicked(m())});f.click(function(){q("");a.clearButtonClicked();e.focus()})})();e.focus()};var PickyBackend=function(a){var b=function(i,e,f){var n=f||{};n=$.extend({query:i},f);$.getJSON(a,n,function(p){e&&e(new PickyData(p))})};this.search=function(i,e,f,n){b(i,function(p){e&&e(n,p)},f)}},LiveBackend=function(a){var b=a.live||alert("A live backend path must be provided."),i=new PickyBackend(b);this.search=function(e,f,n,p){p=p||{};latestRequestTimestamp=new Date;p.live=latestRequestTimestamp;n=$.extend({ids:a.liveResults||0,offset:0},n);i.search(e,function(s,u){if(!s.live||s.live==latestRequestTimestamp)f&&
f(u)},n,p)}},FullBackend=function(a){var b=a.full||alert("A full backend path must be provided."),i=new PickyBackend(b);this.search=function(e,f,n,p){p=p||{};latestRequestTimestamp=new Date;p.full=latestRequestTimestamp;n=$.extend({ids:a.fullResults||20,offset:0},n);i.search(e,function(s,u){if(!s.full||s.full==latestRequestTimestamp)f&&f(u)},n,p)}};var PickyController=function(a){var b=new PickyView(this,a),i=a.backends,e=a.before||function(){},f=a.success||function(){},n=a.after||function(){},p=a.liveRendered||false,s=a.liveSearchInterval||180,u,x=function(c){return(c=c&&c.match(/q=([^&]+)/))&&decodeURIComponent(c[1]).replace(/\+/g," ").replace(/#/g,"")||""};this.extractQuery=x;var y=function(){var c=window.History&&window.History.getState();return x(c&&c.url)};this.lastFullQuery=y;var j=function(c,o,v,k){o=e(o,k)||o;u=[c,o,v,k];var w=o;if(w!=
y()){w="?q="+escape(w).replace(/\*/g,"%2A");window.History&&window.History.getState()&&window.History.pushState&&window.History.pushState(null,null,w)}(c=i[c])&&c.search(o,v,k)};this.resend=function(){u&&j.apply(this,u)};var r=function(c,o){c=f(c,o)||c;b.fullResultsCallback(c);n(c,o)},d=function(c,o){clearInterval(g);j("full",c,r,o||{})};a=function(c,o){c=f(c,o)||c;b.liveResultsCallback(c);n(c,o)};var h=p?r:a,g,q=function(){var c=b.text();j("live",c,h,{});clearInterval(g)};g=setInterval(q,s);clearInterval(g);
var m=function(c,o,v){b.insert(c);v&&d(c,o)};this.insert=m;this.clearButtonClicked=function(){clearInterval(g)};this.searchTextCleared=function(){clearInterval(g)};this.searchTextEntered=function(c,o){if($.inArray(o.keyCode,[0,8,13,32,46,48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90])>-1)if(o.keyCode==13)d(c);else{clearInterval(g);g=setInterval(q,s)}};this.searchButtonClicked=function(c){d(c)};this.allocationChosen=function(c){d(c)};this.addinationClicked=
function(c,o){d(c,{offset:o.data.offset})};window.History&&window.History.Adapter.bind(window,"statechange",function(){var c=window.History.getState();(c=x(c.url))&&c!=(u.length>1&&u[1])&&m(c)})};var Localization={},PickyI18n={};$(function(){PickyI18n.locale=$("html").attr("lang").split("-")[0]||"en"});
var PickyClient=function(a){Localization.qualifiers=a.qualifiers||{};Localization.explanations=a.explanations||{};Localization.choices=a.choices||{};Localization.explanation_delimiters={de:"und",fr:"et",it:"e",en:"and",ch:"und"};var b=a.backends;if(b){b.live||alert("Both a full and live backend must be provided.");b.full||alert("Both a full and live backend must be provided.")}else a.backends={live:new LiveBackend(a),full:new FullBackend(a)};b=a.enclosingSelector||"#picky";a.input=$(a.inputSelector||
b+" input.query");a.reset=$(a.resetSelector||b+" div.reset");a.button=$(a.buttonSelector||b+" input.search_button");a.counter=$(a.counterSelector||b+" div.status");a.dashboard=$(a.dashboardSelector||b+" .dashboard");a.results=$(a.resultsSelector||b+" div.results");a.noResults=$(a.noResultsSelector||b+" .no_results");a.moreSelector=a.moreSelector||b+" div.results div.addination:last";a.allocations=$(a.allocationsSelector||b+" .allocations");a.shownAllocations=a.allocations.find(".shown");a.showMoreAllocations=
a.allocations.find(".more");a.hiddenAllocations=a.allocations.find(".hidden");a.maxSuggestions=a.maxSuggestions||3;a.results=$(a.resultsSelector||b+" div.results");a.resultsDivider=a.resultsDivider||"";a.noAsterisks=a.noAsterisks||[];a.wrapResults=a.wrapResults||'<ol class="results"></ol>';var i=a.controller&&new a.controller(a)||new PickyController(a);var e=this.insert=function(f,n,p){i.insert(f,n||{},p||true)};this.resend=i.resend;this.insertFromURL=function(f){if(f&&f!="")e(f);else(f=i.lastFullQuery())&&
e(f)}};var PickyAddination=function(a,b){this.remove=function(){b.find(".addination").remove()};this.render=function(i){var e=i.total,f,n=i.renderedAmount();f=i.offset+n;n=f+n;i=i.total;if(i<n)n=i;f={offset:f,start:f+1,end:n};if(f.offset<e){e=$("<div class='addination'>"+t("results.addination.more")+"</div>");e.bind("click",{offset:f.offset},a.addinationClicked);return e}else return""}};var PickyResultsRenderer=function(a,b){var i=b.results,e=b.resultsDivider,f=b.wrapResults,n=b.noAsterisks,p=function(j){var r=j[j.length-1];j=j.slice(0,j.length-1);if(j==[])j=[j];if(!n.include(r[0]))if(r[1].match(/[^\*~]$/))r[1]+="*";j.push(r);return j},s=function(j){for(var r=Localization.explanations&&Localization.explanations[PickyI18n.locale]||{},d=[],h,g=0,q=j.length;g<q;g++){h=j[g];var m=h[0];m=r[m]||m;d.push([m,h[1]])}return d},u=function(j,r){return[j.replace(/([\w\s\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00e9\u00e8\u00e0]+)/,
"<strong>$1</strong>"),r].join(" ")},x=function(j,r){var d=Localization.explanation_delimiters[PickyI18n.locale],h=s(p(r)),g="",q=[];h=$.map(h,function(m){var c=m[0];m=m[1];if(g==""||c==g){m=m.replace(/[\w,]+:(.+)/,"$1");q.push(m);g=c}else{var o=u(g,q.join(" "));q=[];q.push(m);g=c;return o}});h.push(u(g,q.join(" ")));h=h.join(" "+d+" ");return'<span class="explanation">'+j+" "+h+"</span>"},y=function(j,r){var d='<div class="header">';d+=x(r.type,r.combination);if(j.offset>0)d+='<div class="tothetop"><a href="#" onclick="javascript:$(\'body\').animate({scrollTop: 0}, 500);">&uarr;</a></div>';
return d};this.render=function(j){j.allocations.each(function(r,d){if(d.entries.length>0){i.append(y(j,d)).append(d.entries.join(e));i.children("li").wrapAll(f)}});i.append(a.render(j))}};function AllocationRenderer(a,b){function i(d){var h={},g={},q=[],m;m=0;for(l=d.length;m<l;m++){var c=d[m][0];if(c in h){h[c]=h[c]+" "+d[m][1];q.push(m)}else{h[c]=d[m][1];g[m]=c}}for(m in g)d[m][1]=h[g[m]];for(m=q.length-1;m>=0;m--)d.remove(q[m]);return d}function e(d){return $.map(d,function(h,g){return"%"+(g+1)+"$s"}).join(" ")}function f(d){if(d.length==0)return"";var h=d=i(d);h.sort(function(w,z){return w[0]<z[0]?-1:1});for(var g=[],q=0,m=h.length;q<m;q++)g.push(h[q][0]);var c=g.length==1,o=j[g]||
(j[g]=e(g));if($.type(o)==="string"){j[g]={format:o};o=j[g]}var v=1,k=o.format;$.each(d,function(w,z){var A=z[0],B=z[2];if(o.filter)B=o.filter(B);A=x[A]||A;if(c&&!(o&&o.ignoreSingle))return k=B+"&nbsp;("+A+")";k=k.replace(RegExp("%"+v+"\\$s","g"),B);v+=1;return v});return k}function n(d){for(var h=[],g=0,q=y.length;g<q;g++)h.push([]);h.push([]);g=0;for(q=d.length;g<q;g++){for(var m=d[g],c=m[0],o=false,v=0,k=y.length;v<k;v++)if(y[v].include(c)){h[v].push(m);o=true;break}o||h[h.length-1].push(m)}var w;
for(d=h.length-1;d>=0;d--){w=h[d];if(w.length>0)break}w=w[w.length-1];r.include(w[0])||(w[1]+="...");return $.map(h,function(z){return f(z)})}function p(d){var h=[],g,q;for(q in d){g=d[q][0];g=u[g]||g;h[q]=g+":"+d[q][2]}return h.join(" ")}var s=PickyI18n.locale,u=Localization.qualifiers&&Localization.qualifiers[s]||{},x=Localization.explanations&&Localization.explanations[s]||{},y=b.groups||[],j=Localization.choices&&Localization.choices[s]||{};this.explanation=this.query=this.text="";var r=["street_number",
"zipcode"];this.contract=i;this.rendered=f;this.groupify=n;this.querify=p;this.render=function(d){var h=d.combination,g=d.count;d=p(h);h=n(h).join(" ");h=$('<li><div class="text">'+h+'</div><div class="count">'+g+"</div></li>");h.bind("click",{query:d},a);return h}};var PickyAllocationsCloud=function(a,b){var i=b.allocations,e=b.shownAllocations,f=b.showMoreAllocations,n=b.hiddenAllocations,p=b.maxSuggestions,s=function(){i.hide()},u=new AllocationRenderer(function(j){s();a.allocationChosen(j)},b),x=function(j){var r=[];j.each(function(d,h){r.push(u.render(h))});return r},y=function(j){if(j.length==0)return i.hide();e.empty();f.hide();n.empty().hide();if(j.length>p){$.each(j.slice(0,p-1),function(r,d){e.append(d)});$.each(j.slice(p-1),function(r,d){n.append(d)});
f.show()}else $.each(j,function(r,d){e.append(d)});return i.show()};f.click(function(){f.hide();n.show()});this.hide=s;this.show=function(j){y(x(j.allocations));i.show()}};
